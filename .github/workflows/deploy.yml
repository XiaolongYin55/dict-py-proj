name: Auto Deploy to Ubuntu

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Pull Latest Code
      run: |
        cd /home/parallels/myDict
        git stash
        git reset --hard HEAD
        git pull origin main
        echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"
        
    - name: Clean Environment
      run: |
        cd /home/parallels/myDict
        docker-compose down --volumes --remove-orphans 2>/dev/null || true
        docker system prune -f
        echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
        
    - name: Rebuild Services
      run: |
        cd /home/parallels/myDict
        docker-compose build --no-cache
        echo "âœ… æœåŠ¡é‡å»ºå®Œæˆ"
        
    - name: Start Database
      run: |
        cd /home/parallels/myDict
        docker-compose up -d db
        echo "â³ ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨ï¼ˆ60ç§’ï¼‰..."
        sleep 60
        echo "âœ… æ•°æ®åº“å¯åŠ¨å®Œæˆ"
        
    - name: Run Database Migrations
      run: |
        cd /home/parallels/myDict
        echo "ğŸ”§ è¿è¡Œæ•°æ®åº“è¿ç§»..."
        docker-compose run --rm web python manage.py migrate
        echo "âœ… è¿ç§»å®Œæˆ"
        
    - name: Start Web Service
      run: |
        cd /home/parallels/myDict
        docker-compose up -d web
        echo "âœ… WebæœåŠ¡å¯åŠ¨å®Œæˆ"
        
    - name: Health Check
      run: |
        cd /home/parallels/myDict
        echo "ğŸ” å¥åº·æ£€æŸ¥..."
        
        # ç­‰å¾…åº”ç”¨å¯åŠ¨
        sleep 30
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        docker-compose ps
        
        # å¥åº·æ£€æŸ¥
        timeout=30
        for i in $(seq 1 6); do
          if curl -f http://localhost:8000/api/users/ &>/dev/null; then
            echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          fi
          echo "â±ï¸  ç­‰å¾…åº”ç”¨å¯åŠ¨... ($i/6)"
          sleep 5
        done
        
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ!"
        echo "ğŸŒ è®¿é—®åœ°å€: http://10.211.55.9:8000/api/users/"
