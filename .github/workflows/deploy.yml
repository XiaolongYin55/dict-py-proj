name: Safe Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
    - name: Force Sync Latest Code
      run: |
        echo "ğŸ“¥ å¼ºåˆ¶åŒæ­¥æœ€æ–°ä»£ç ..."
        cd /home/laurence/dict-py-proj
        
        # å¼ºåˆ¶åŒæ­¥ï¼Œç¡®ä¿ä»£ç å®Œå…¨æ›´æ–°
        git fetch --all
        git reset --hard origin/main
        git clean -fd -q
        echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
        
    - name: Stop Services Safely
      run: |
        echo "ğŸ›‘ å®‰å…¨åœæ­¢æœåŠ¡..."
        cd /home/laurence/dict-py-proj
        docker-compose down --remove-orphans || true
        echo "âœ… æœåŠ¡å·²åœæ­¢"
        
    - name: Clean Docker Cache
      run: |
        echo "ğŸ§¹ æ¸…ç†Dockerç¼“å­˜..."
        docker image prune -f
        
    - name: Build Services
      run: |
        echo "ğŸ”¨ æ„å»ºæœåŠ¡..."
        cd /home/laurence/dict-py-proj
        docker-compose build
        
    - name: Start Database
      run: |
        echo "ğŸ—„ï¸ å¯åŠ¨æ•°æ®åº“..."
        cd /home/laurence/dict-py-proj
        docker-compose up -d db
        
        echo "â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
        for i in {1..30}; do
          if docker-compose exec db mysql -uroot -p12345678 -e "SELECT 1;" &>/dev/null; then
            echo "âœ… æ•°æ®åº“å·²å°±ç»ª"
            break
          fi
          sleep 2
        done
        
    - name: Start Web Service
      run: |
        echo "ğŸŒ å¯åŠ¨WebæœåŠ¡..."
        cd /home/laurence/dict-py-proj
        docker-compose up -d web
        
    - name: Verify Deployment
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²..."
        cd /home/laurence/dict-py-proj
        sleep 10
        docker-compose ps
        echo "ğŸ‰ CI/CDéƒ¨ç½²æˆåŠŸå®Œæˆ!"
