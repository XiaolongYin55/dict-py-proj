name: Safe Auto Deploy - Preserve Data

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Force Sync Latest Code
      run: |
        echo "ğŸ“¥ å¼ºåˆ¶åŒæ­¥æœ€æ–°ä»£ç ..."
        cd /home/laurence/dict-py-proj
        
        git fetch --all
        git reset --hard origin/main
        git clean -fd -q
        echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
    
    - name: Stop Web Service Only (Keep DB)
      run: |
        echo "ğŸ›‘ å®‰å…¨åœæ­¢WebæœåŠ¡..."
        cd /home/laurence/dict-py-proj
        
        # åªåœæ­¢webï¼Œä¸åœæ­¢dbï¼Œä¿ç•™å·
        docker-compose stop web || true
        docker-compose rm -f web || true
        
        echo "âœ… WebæœåŠ¡å·²åœæ­¢ï¼Œæ•°æ®åº“ä¿æŒè¿è¡Œ"
    
    - name: Clean Docker Cache (Safe)
      run: |
        echo "ğŸ§¹ æ¸…ç†Dockerç¼“å­˜..."
        
        docker image prune -f --filter "until=72h" || true
        
        echo "âœ… Dockerç¼“å­˜å·²æ¸…ç†"
    
    - name: Build Web Service Only
      run: |
        echo "ğŸ”¨ æ„å»ºWebæœåŠ¡..."
        cd /home/laurence/dict-py-proj
        docker-compose build web
    
    - name: Start Web Service
      run: |
        echo "ğŸŒ å¯åŠ¨WebæœåŠ¡..."
        cd /home/laurence/dict-py-proj
        docker-compose up -d web
        
        echo "â³ ç­‰å¾…WebæœåŠ¡å°±ç»ª..."
        for i in {1..30}; do
          if docker-compose exec -T web python manage.py migrate &>/dev/null; then
            echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
            break
          fi
          echo "  ç­‰å¾…ä¸­... ($i/30)"
          sleep 2
        done
    
    - name: Verify Deployment
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²..."
        cd /home/laurence/dict-py-proj
        sleep 5
        docker-compose ps
        echo "ğŸ‰ CI/CDéƒ¨ç½²æˆåŠŸå®Œæˆï¼"
    
    - name: Show Database Status
      run: |
        echo "ğŸ“Š æ•°æ®åº“çŠ¶æ€ï¼š"
        cd /home/laurence/dict-py-proj
        docker volume ls | grep mydict
        docker-compose exec -T db mysql -uroot -p12345678 -e "SHOW DATABASES;"
