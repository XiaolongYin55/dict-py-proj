name: Auto Deploy to Ubuntu

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Pull Latest Code
      run: |
        cd /home/parallels/myDict
        git stash
        git reset --hard HEAD
        git pull origin main
        echo "✅ 代码更新完成"
        
    - name: Stop Services
      run: |
        cd /home/parallels/myDict
        docker-compose down
        echo "✅ 服务已停止"
        
    - name: Rebuild Services
      run: |
        cd /home/parallels/myDict
        docker system prune -f
        docker-compose build --no-cache
        echo "✅ 服务重建完成"
        
    - name: Start Database with Health Check (30秒)
      run: |
        cd /home/parallels/myDict
        docker-compose up -d db
        echo "⏳ 等待数据库完全启动（最多30秒）..."
        
        # 健康检查，30秒超时（6次×5秒）
        for i in {1..6}; do
          if docker-compose exec -T db mysql -uroot -p12345678 -e "SELECT 1;" &>/dev/null; then
            echo "✅ 数据库已就绪 (尝试 $i/6)"
            break
          else
            echo "⏱️  等待数据库... (尝试 $i/6)"
            sleep 5
          fi
        done
        
        # 最终验证
        docker-compose exec -T db mysql -uroot -p12345678 -e "SHOW DATABASES;" && echo "✅ 数据库验证成功" || echo "⚠️ 数据库可能未完全就绪"
        echo "✅ 数据库启动完成"
        
    - name: Start Web Service
      run: |
        cd /home/parallels/myDict
        docker-compose up -d web
        echo "✅ Web服务启动完成"
        
    - name: Wait for Django (20秒)
      run: |
        cd /home/parallels/myDict
        echo "⏳ 等待Django应用启动（最多20秒）..."
        
        # 等待Django健康，20秒超时（4次×5秒）
        for i in {1..4}; do
          if curl -f http://localhost:8000/api/users/ &>/dev/null; then
            echo "✅ Django应用已就绪 (尝试 $i/4)"
            break
          else
            echo "⏱️  等待Django... (尝试 $i/4)"
            sleep 5
          fi
        done
        echo "✅ 应用健康检查完成"
        
    - name: Run Migrations
      run: |
        cd /home/parallels/myDict
        docker-compose exec -T web python manage.py migrate
        echo "✅ 数据库迁移完成"
        
    - name: Final Check
      run: |
        cd /home/parallels/myDict
        docker-compose ps
        curl -s http://localhost:8000/api/users/ | head -2
        echo "🎉 部署完成!"
        echo "🌐 访问地址: http://10.211.55.9:8000"
