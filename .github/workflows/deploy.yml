name: Safe Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Stop services safely
      run: |
        echo "🛑 安全停止服务..."
        cd /home/laurence/dict-py-proj
        docker-compose down --remove-orphans || true
        echo "✅ 服务已停止（保留数据卷）"
        
    - name: Clean docker cache selectively
      run: |
        echo "🧹 选择性清理Docker缓存..."
        docker image prune -f
        docker system df
        
    - name: Build with cache
      run: |
        echo "🔨 构建镜像（使用缓存）..."
        cd /home/laurence/dict-py-proj
        docker-compose build
        
    - name: Start database first
      run: |
        echo "🗄️ 先启动数据库..."
        cd /home/laurence/dict-py-proj
        docker-compose up -d db
        
        echo "⏳ 等待数据库就绪..."
        for i in {1..30}; do
          if docker-compose exec db mysql -uroot -p12345678 -e "SELECT 1;" &>/dev/null; then
            echo "✅ 数据库已就绪"
            break
          fi
          echo "等待数据库... ($i/30)"
          sleep 5
        done
        
    - name: Start web service
      run: |
        echo "🌐 启动Web服务..."
        cd /home/laurence/dict-py-proj
        docker-compose up -d web
        
    - name: Verify deployment
      run: |
        echo "🔍 验证部署..."
        cd /home/laurence/dict-py-proj
        sleep 10
        docker-compose ps
        docker-compose logs web --tail=20
        
    - name: Health check
      run: |
        echo "❤️ 健康检查..."
        cd /home/laurence/dict-py-proj
        if curl -f http://localhost:8000/admin/ &>/dev/null; then
          echo "✅ 健康检查通过"
        else
          echo "⚠️ 健康检查失败，但继续保留环境"
          docker-compose logs web --tail=30
        fi
        
    - name: Handle failure gracefully
      if: failure()
      run: |
        echo "❌ 部署失败，保留环境用于排查..."
        cd /home/laurence/dict-py-proj
        docker-compose logs > /home/laurence/deploy_failure_$(date +%Y%m%d_%H%M%S).log || echo "日志保存失败但继续"
        docker system df >> /home/laurence/deploy_failure_$(date +%Y%m%d_%H%M%S).log || echo "系统信息保存失败但继续"
        echo "📄 失败处理完成"
