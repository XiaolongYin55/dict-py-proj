name: Auto Deploy to Ubuntu

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Pull Latest Code
      run: |
        cd /home/parallels/myDict
        git stash
        git reset --hard HEAD
        git pull origin main
        echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"
        
    - name: Stop Services
      run: |
        cd /home/parallels/myDict
        docker-compose down
        echo "âœ… æœåŠ¡å·²åœæ­¢"
        
    - name: Rebuild Web Service Only
      run: |
        cd /home/parallels/myDict
        docker-compose build --no-cache web
        echo "âœ… WebæœåŠ¡æ„å»ºå®Œæˆ"
        
    - name: Start Database
      run: |
        cd /home/parallels/myDict
        docker-compose up -d db
        echo "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
        sleep 45
        
    - name: Start Web Service
      run: |
        cd /home/parallels/myDict
        docker-compose up -d web
        echo "âœ… æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆ"
        
    - name: Run Migrations
      run: |
        cd /home/parallels/myDict
        sleep 10
        docker-compose exec -T web python manage.py migrate
        echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
        
    - name: Check Status
      run: |
        cd /home/parallels/myDict
        docker-compose ps
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
        echo "ğŸŒ è®¿é—®åœ°å€: http://10.211.55.9:8000"
