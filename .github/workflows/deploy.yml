name: Auto Deploy to Ubuntu

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Pull Latest Code
      run: |
        cd /home/parallels/myDict
        git stash
        git reset --hard HEAD
        git pull origin main
        echo "✅ 代码更新完成"
        
    - name: Rebuild Services
      run: |
        cd /home/parallels/myDict
        docker-compose down
        docker-compose build --no-cache
        docker-compose up -d db
        echo "⏳ 等待数据库启动..."
        sleep 30
        docker-compose up -d web
        echo "✅ 服务重建完成"
        
    - name: Run Migrations
      run: |
        cd /home/parallels/myDict
        # 使用 -T 参数禁用 TTY
        docker-compose exec -T web python manage.py migrate
        echo "✅ 数据库迁移完成"
        
    - name: Check Status
      run: |
        cd /home/parallels/myDict
        docker-compose ps
        echo "🎉 部署完成!"
        echo "🌐 访问地址: http://10.211.55.9:8000"
