name: Safe Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Stop services safely
      run: |
        echo "ğŸ›‘ å®‰å…¨åœæ­¢æœåŠ¡..."
        cd /home/laurence/dict-py-proj
        docker-compose down --remove-orphans || true
        echo "âœ… æœåŠ¡å·²åœæ­¢ï¼ˆä¿ç•™æ•°æ®å·ï¼‰"
        
    - name: Clean docker cache selectively
      run: |
        echo "ğŸ§¹ é€‰æ‹©æ€§æ¸…ç†Dockerç¼“å­˜..."
        docker image prune -f
        docker system df
        
    - name: Build with cache
      run: |
        echo "ğŸ”¨ æ„å»ºé•œåƒï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰..."
        cd /home/laurence/dict-py-proj
        docker-compose build
        
    - name: Start database first
      run: |
        echo "ğŸ—„ï¸ å…ˆå¯åŠ¨æ•°æ®åº“..."
        cd /home/laurence/dict-py-proj
        docker-compose up -d db
        
        echo "â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
        for i in {1..30}; do
          if docker-compose exec db mysql -uroot -p12345678 -e "SELECT 1;" &>/dev/null; then
            echo "âœ… æ•°æ®åº“å·²å°±ç»ª"
            break
          fi
          echo "ç­‰å¾…æ•°æ®åº“... ($i/30)"
          sleep 5
        done
        
    - name: Start web service
      run: |
        echo "ğŸŒ å¯åŠ¨WebæœåŠ¡..."
        cd /home/laurence/dict-py-proj
        docker-compose up -d web
        
    - name: Verify deployment
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²..."
        cd /home/laurence/dict-py-proj
        sleep 10
        docker-compose ps
        docker-compose logs web --tail=20
        
    - name: Health check
      run: |
        echo "â¤ï¸ å¥åº·æ£€æŸ¥..."
        cd /home/laurence/dict-py-proj
        if curl -f http://localhost:8000/admin/ &>/dev/null; then
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­ä¿ç•™ç¯å¢ƒ"
          docker-compose logs web --tail=30
        fi
        
    - name: Handle failure gracefully
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œä¿ç•™ç¯å¢ƒç”¨äºæ’æŸ¥..."
        cd /home/laurence/dict-py-proj
        docker-compose logs > /home/laurence/deploy_failure_$(date +%Y%m%d_%H%M%S).log || echo "æ—¥å¿—ä¿å­˜å¤±è´¥ä½†ç»§ç»­"
        docker system df >> /home/laurence/deploy_failure_$(date +%Y%m%d_%H%M%S).log || echo "ç³»ç»Ÿä¿¡æ¯ä¿å­˜å¤±è´¥ä½†ç»§ç»­"
        echo "ğŸ“„ å¤±è´¥å¤„ç†å®Œæˆ"
