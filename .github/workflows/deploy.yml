name: Auto Deploy to Ubuntu

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Pull Latest Code
      run: |
        cd /home/parallels/myDict
        git stash
        git reset --hard HEAD
        git pull origin main
        echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"
        
    - name: Stop Services
      run: |
        cd /home/parallels/myDict
        docker-compose down
        echo "âœ… æœåŠ¡å·²åœæ­¢"
        
    - name: Rebuild Services
      run: |
        cd /home/parallels/myDict
        docker system prune -f
        docker-compose build --no-cache
        echo "âœ… æœåŠ¡é‡å»ºå®Œæˆ"
        
    - name: Start Database with Health Check
      run: |
        cd /home/parallels/myDict
        docker-compose up -d db
        echo "â³ ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨..."
        
        # å¥åº·æ£€æŸ¥ï¼Œç­‰å¾…æ•°æ®åº“çœŸæ­£å°±ç»ª
        for i in {1..12}; do
          if docker-compose exec db mysql -uroot -p12345678 -e "SELECT 1;" &>/dev/null; then
            echo "âœ… æ•°æ®åº“å·²å°±ç»ª (å°è¯• $i/12)"
            break
          else
            echo "â±ï¸  ç­‰å¾…æ•°æ®åº“... (å°è¯• $i/12)"
            sleep 10
          fi
        done
        
        # æœ€ç»ˆéªŒè¯
        docker-compose exec db mysql -uroot -p12345678 -e "SHOW DATABASES;" || echo "âŒ æ•°æ®åº“å¯åŠ¨å¤±è´¥"
        echo "âœ… æ•°æ®åº“å¯åŠ¨å®Œæˆ"
        
    - name: Start Web Service
      run: |
        cd /home/parallels/myDict
        docker-compose up -d web
        echo "âœ… WebæœåŠ¡å¯åŠ¨å®Œæˆ"
        
    - name: Wait for Django
      run: |
        cd /home/parallels/myDict
        echo "â³ ç­‰å¾…Djangoåº”ç”¨å¯åŠ¨..."
        
        # ç­‰å¾…Djangoå¥åº·
        for i in {1..10}; do
          if curl -f http://localhost:8000/api/users/ &>/dev/null; then
            echo "âœ… Djangoåº”ç”¨å·²å°±ç»ª (å°è¯• $i/10)"
            break
          else
            echo "â±ï¸  ç­‰å¾…Django... (å°è¯• $i/10)"
            sleep 5
          fi
        done
        echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥å®Œæˆ"
        
    - name: Run Migrations
      run: |
        cd /home/parallels/myDict
        docker-compose exec -T web python manage.py migrate
        echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
        
    - name: Final Check
      run: |
        cd /home/parallels/myDict
        docker-compose ps
        curl -s http://localhost:8000/api/users/ | head -2
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
        echo "ğŸŒ è®¿é—®åœ°å€: http://10.211.55.9:8000"
