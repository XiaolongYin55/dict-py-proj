name: Auto Deploy to Ubuntu

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Pull Latest Code
      run: |
        cd /home/parallels/myDict
        git stash
        git reset --hard HEAD
        git pull origin main
        echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"
        
    - name: Stop Services
      run: |
        cd /home/parallels/myDict
        docker-compose down
        echo "âœ… æœåŠ¡å·²åœæ­¢"
        
    - name: Rebuild Services
      run: |
        cd /home/parallels/myDict
        docker system prune -f
        docker-compose build --no-cache
        echo "âœ… æœåŠ¡é‡å»ºå®Œæˆ"
        
    - name: Start Database with Health Check (30ç§’)
      run: |
        cd /home/parallels/myDict
        docker-compose up -d db
        echo "â³ ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨ï¼ˆæœ€å¤š30ç§’ï¼‰..."
        
        # å¥åº·æ£€æŸ¥ï¼Œ30ç§’è¶…æ—¶ï¼ˆ6æ¬¡Ã—5ç§’ï¼‰
        for i in {1..6}; do
          if docker-compose exec -T db mysql -uroot -p12345678 -e "SELECT 1;" &>/dev/null; then
            echo "âœ… æ•°æ®åº“å·²å°±ç»ª (å°è¯• $i/6)"
            break
          else
            echo "â±ï¸  ç­‰å¾…æ•°æ®åº“... (å°è¯• $i/6)"
            sleep 5
          fi
        done
        
        # æœ€ç»ˆéªŒè¯
        docker-compose exec -T db mysql -uroot -p12345678 -e "SHOW DATABASES;" && echo "âœ… æ•°æ®åº“éªŒè¯æˆåŠŸ" || echo "âš ï¸ æ•°æ®åº“å¯èƒ½æœªå®Œå…¨å°±ç»ª"
        echo "âœ… æ•°æ®åº“å¯åŠ¨å®Œæˆ"
        
    - name: Start Web Service
      run: |
        cd /home/parallels/myDict
        docker-compose up -d web
        echo "âœ… WebæœåŠ¡å¯åŠ¨å®Œæˆ"
        
    - name: Wait for Django (20ç§’)
      run: |
        cd /home/parallels/myDict
        echo "â³ ç­‰å¾…Djangoåº”ç”¨å¯åŠ¨ï¼ˆæœ€å¤š20ç§’ï¼‰..."
        
        # ç­‰å¾…Djangoå¥åº·ï¼Œ20ç§’è¶…æ—¶ï¼ˆ4æ¬¡Ã—5ç§’ï¼‰
        for i in {1..4}; do
          if curl -f http://localhost:8000/api/users/ &>/dev/null; then
            echo "âœ… Djangoåº”ç”¨å·²å°±ç»ª (å°è¯• $i/4)"
            break
          else
            echo "â±ï¸  ç­‰å¾…Django... (å°è¯• $i/4)"
            sleep 5
          fi
        done
        echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥å®Œæˆ"
        
    - name: Run Migrations
      run: |
        cd /home/parallels/myDict
        docker-compose exec -T web python manage.py migrate
        echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
        
    - name: Final Check
      run: |
        cd /home/parallels/myDict
        docker-compose ps
        curl -s http://localhost:8000/api/users/ | head -2
        echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
        echo "ğŸŒ è®¿é—®åœ°å€: http://10.211.55.9:8000"
