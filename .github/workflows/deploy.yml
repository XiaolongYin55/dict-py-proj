name: Auto Deploy to Ubuntu

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Stop Services First
      run: |
        cd /home/laurence/myDict
        echo "â¹ï¸  å…ˆåœæ­¢æ‰€æœ‰æœåŠ¡é¿å…å†²çª..."
        docker compose stop web 2>/dev/null || true
        docker compose down 2>/dev/null || true
        echo "âœ… æœåŠ¡å·²åœæ­¢"
        
    - name: Pull Latest Code
      run: |
        cd /home/laurence/myDict
        git stash
        git reset --hard HEAD
        git pull origin main
        echo "âœ… ä»£ç æ›´æ–°å®Œæˆ"
        
    - name: Clean Environment
      run: |
        cd /home/laurence/myDict
        docker compose down --volumes --remove-orphans 2>/dev/null || true
        docker system prune -f
        echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
        
    - name: Rebuild Services
      run: |
        cd /home/laurence/myDict
        docker compose build --no-cache
        echo "âœ… æœåŠ¡é‡å»ºå®Œæˆ"
        
    - name: Start Database with Wait
      run: |
        cd /home/laurence/myDict
        docker compose up -d db
        echo "â³ ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨ï¼ˆ60ç§’ï¼‰..."
        sleep 60
        echo "âœ… æ•°æ®åº“å¯åŠ¨å®Œæˆ"
        
    - name: Verify Database Connection
      run: |
        cd /home/laurence/myDict
        echo "ğŸ” éªŒè¯æ•°æ®åº“è¿æ¥..."
        if docker compose exec -T db mysql -uroot -p12345678 -e "SELECT 1;" &>/dev/null; then
          echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
        else
          echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
          docker compose logs db
          exit 1
        fi
        
    - name: Run Database Migrations
      run: |
        cd /home/laurence/myDict
        echo "ğŸ”§ è¿è¡Œæ•°æ®åº“è¿ç§»..."
        docker compose run --rm web python manage.py migrate
        echo "âœ… è¿ç§»å®Œæˆ"
        
    - name: Start Web Service
      run: |
        cd /home/laurence/myDict
        docker compose up -d web
        echo "âœ… WebæœåŠ¡å¯åŠ¨å®Œæˆ"
        
    - name: Wait for Application
      run: |
        cd /home/laurence/myDict
        echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨ï¼ˆ30ç§’ï¼‰..."
        sleep 30
        
    - name: Final Health Check
      run: |
        cd /home/laurence/myDict
        echo "ğŸ” æœ€ç»ˆå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        docker compose ps
        
        # å¥åº·æ£€æŸ¥
        for i in $(seq 1 6); do
          if curl -f http://localhost:8000/api/users/ &>/dev/null; then
            echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
            echo "ğŸ‰ è‡ªåŠ¨åŒ–éƒ¨ç½²æˆåŠŸ!"
            echo "ğŸŒ è®¿é—®åœ°å€: http://192.168.181.129:8000"
            break
          else
            echo "â±ï¸  ç­‰å¾…åº”ç”¨å¯åŠ¨... ($i/6)"
            sleep 5
          fi
        done
        
        # å¦‚æœå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œæ˜¾ç¤ºæ—¥å¿—
        if ! curl -f http://localhost:8000/api/users/ &>/dev/null; then
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—:"
          docker compose logs web
          exit 1
        fi
